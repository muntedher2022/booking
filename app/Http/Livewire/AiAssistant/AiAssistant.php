<?php

namespace App\Http\Livewire\AiAssistant;

use App\Models\AiConversation;
use App\Models\AiMessage;
use Livewire\Component;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class AiAssistant extends Component
{
    public $conversations = [];
    public $currentConversation = null;
    public $messages = [];
    public $newMessage = '';
    public $newConversationTitle = '';

    protected $listeners = [
        'refreshConversations' => 'loadConversations',
    ];

    protected $rules = [
        'newMessage' => 'required|string',
    ];

    public function mount()
    {
        $this->loadConversations();
    }

    public function loadConversations()
    {
        $this->conversations = AiConversation::where('user_id', Auth::id())
            ->orderBy('updated_at', 'desc')
            ->get();
    }

    public function createNewConversation()
    {
        $conversation = AiConversation::create([
            'user_id' => Auth::id(),
            'title' => $this->newConversationTitle ?: 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ',
        ]);

        $this->newConversationTitle = '';
        $this->loadConversations();
        $this->selectConversation($conversation->id);
    }

    public function selectConversation($conversationId)
    {
        $this->currentConversation = AiConversation::findOrFail($conversationId);
        $this->messages = $this->currentConversation->messages()->orderBy('created_at', 'asc')->get();
    }

    public function sendMessage()
    {
        $messages = [
            'newMessage.required' => 'ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑุณุงูุฉ',
            'newMessage.string' => 'ูุฌุจ ุฃู ุชููู ุงูุฑุณุงูุฉ ูุตูุฉ'
        ];

        $this->validate($this->rules, $messages);

        if (!$this->currentConversation) {
            $this->createNewConversation();
        }

        // ุญูุธ ุฑุณุงูุฉ ุงููุณุชุฎุฏู
        AiMessage::create([
            'conversation_id' => $this->currentConversation->id,
            'type' => 'user',
            'content' => $this->newMessage,
        ]);

        // ุงูุญุตูู ุนูู ุฑุฏ ูู Gemini API
        $aiResponse = $this->getGeminiResponse($this->newMessage);

        // ุญูุธ ุฑุฏ ุงููุณุงุนุฏ ุงูุฐูู
        AiMessage::create([
            'conversation_id' => $this->currentConversation->id,
            'type' => 'assistant',
            'content' => $aiResponse,
        ]);

        // ุชุญุฏูุซ ุนููุงู ุงููุญุงุฏุซุฉ ุฅุฐุง ูุงูุช ุฌุฏูุฏุฉ
        if ($this->currentConversation->title === 'ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ') {
            $this->currentConversation->update([
                'title' => substr($this->newMessage, 0, 30) . (strlen($this->newMessage) > 30 ? '...' : ''),
            ]);
        }

        $this->newMessage = '';
        $this->selectConversation($this->currentConversation->id);
    }

    public function deleteConversation($conversationId)
    {
        AiConversation::findOrFail($conversationId)->delete();
        $this->currentConversation = null;
        $this->messages = [];
        $this->loadConversations();
    }

    private function getGeminiResponse($message)
    {
        $specialResponses = [
            // ุฑุฏูุฏ ุงูุดูุฑ
            'ุดูุฑุง' => "ุงูุนูู! ๐ ูุง ุชุชุฑุฏุฏ ูู ุณุคุงูู ุฅุฐุง ูุงู ูุฏูู ุฃู ุงุณุชูุณุงุฑุงุช ุฃุฎุฑู.",
            'ุดูุฑุงู' => "ุนูู ุงูุฑุญุจ ูุงูุณุนุฉ! ๐ ูุญู ููุง ููุณุงุนุฏุชู ุฏุงุฆูุงู.",
            'thanks' => "You're welcome! ๐ Let me know if you need any further assistance.",
            'thank you' => "My pleasure! ๐ค How else can I assist you today?",
            'merci' => "De rien! ๐ N'hรฉsitez pas ร me poser d'autres questions.",

            // ุฑุฏูุฏ ุงูุชุญูุฉ
            'ูุฑุญุจุง' => "ูุฑุญุจุงู ุจู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            'ุงูุณูุงู ุนูููู' => "ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ๐น ููู ุฃุณุงุนุฏูุ",
            'ุงููุง' => "ุฃููุงู ูุณููุงู! ๐ ูุง ุงูุฐู ุชุญุชุงุฌ ูุณุงุนุฏุชู ูููุ",
            'hello' => "Hello there! ๐ How can I help you today?",
            'hi' => "Hi! ๐ What can I do for you?",
            'bonjour' => "Bonjour! ๐ Comment puis-je vous aider?",

            // ุฑุฏูุฏ ุฃุฎุฑู
            'ุตุจุงุญ ุงูุฎูุฑ' => "ุตุจุงุญ ุงูููุฑ! ๐ ููู ูููููู ุฎุฏูุชู ูุฐุง ุงูุตุจุงุญุ",
            'ูุณุงุก ุงูุฎูุฑ' => "ูุณุงุก ุงูููุฑ! ๐ ููู ุฃุณุงุนุฏู ูุฐุง ุงููุณุงุกุ",
            'ููู ุญุงูู' => "ุฃูุง ุจุฎูุฑุ ุดูุฑุงู ูุณุคุงูู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",

            'ูุง ุงุณูู' => "ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ููุธุงู ุฅุฏุงุฑุฉ ุงููุฑุงุณูุงุช ุงูุฑุณููุฉ. ููููู ููุงุฏุงุชู ุจู 'ุงููุณุงุนุฏ'! ๐ค",
            'ูู ุตูุนู' => "ุชู ุชุทููุฑู ููุณุงุนุฏุฉ ููุธูู ุงููุคุณุณุฉ ูู ุฅุฏุงุฑุฉ ุงููุฑุงุณูุงุช ุงูุฑุณููุฉ ุจุดูู ุฃูุซุฑ ููุงุกุฉ. ๐ผ",
            'ูุณุงุนุฏุฉ' => "ูููููู ูุณุงุนุฏุชู ูู:\n- ุฅุฑุณุงู ุงููุชุจ ุงูุฑุณููุฉ\n- ุงุณุชุนุฑุงุถ ุงูุชูุงุฑูุฑ\n- ุดุฑุญ ุงุณุชุฎุฏุงู ุงููุธุงู\nูุง ุงูุฐู ุชุฑูุฏ ูุนุฑูุชูุ",
        ];

        // ุชูุธูู ุงูุฑุณุงูุฉ ูุงูุชุญูู ูู ุงูุฑุฏูุฏ ุงููุฎุตุตุฉ
        $lowerMessage = mb_strtolower(trim($message));
        $normalizedMessage = preg_replace('/[^\p{L}\p{N}\s]/u', '', $lowerMessage); // ุฅุฒุงูุฉ ุนูุงูุงุช ุงูุชุฑููู

        foreach ($specialResponses as $keyword => $response) {
            $normalizedKeyword = mb_strtolower(preg_replace('/[^\p{L}\p{N}\s]/u', '', $keyword));

            // ุงูุชุญูู ูู ูุฌูุฏ ุงููููุฉ ุงูููุชุงุญูุฉ ูู ุงูุฑุณุงูุฉ
            if (str_contains($normalizedMessage, $normalizedKeyword)) {
                return $response;
            }
        }

        $faqs = [
            // ูุนูููุงุช ุนุงูุฉ ุนู ุงููุธุงู
            'ูุฐุง ุงููุธุงู' => "ุฃูุง ูุณุงุนุฏ ุฐูู ูุฏูุฌ ูู ูุธุงู ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช ุงูุฑุณููุฉ ูููุคุณุณุฉ. ูุฐุง ุงููุธุงู ูุชูุญ:\n\n"
                . "โข ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช ุงูุฑุณููุฉ ุงูุฏุงุฎููุฉ ูุงูุฎุงุฑุฌูุฉ\n"
                . "โข ุฃุฑุดูุฉ ุงููุณุชูุฏุงุช ุงูุตุงุฏุฑุฉ ูุงููุงุฑุฏุฉ\n"
                . "โข ุฅููุงููุฉ ุงูุชุตุฏูุฑ ูุงูุทุจุงุนุฉ\n"
                . "โข ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ุงูุฅุฏุงุฑูุฉ\n"
                . "โข ุงููุณุฎ ุงูุงุญุชูุงุทู ูููุณุชูุฏุงุช\n"
                . "โข ุฅุฏุงุฑุฉ ุงููุชุจ ุงูุฑุณููุฉ ููุณุฎูุง ุถูุฆูุงู\n\n"
                . "ุฃูุง ููุง ููุณุงุนุฏุชู ูู ุงุณุชุฎุฏุงู ูุฐุง ุงููุธุงู ูุงูุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุชู.",

            'ูููุฒุงุช ุงููุธุงู' => "ุฃูู ูููุฒุงุช ุงููุธุงู:\n\n"
                . "๐ ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช ุงูุฑุณููุฉ (ุตุงุฏุฑ/ูุงุฑุฏ)\n"
                . "๐ ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ุงูุฅุญุตุงุฆูุฉ\n"
                . "๐๏ธ ุฃุฑุดูุฉ ุงููุณุชูุฏุงุช ุจุดูู ููุธู\n"
                . "๐ง ุฅุฏุงุฑุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู\n"
                . "๐ ูุธุงู ุตูุงุญูุงุช ูุชูุงูู\n"
                . "๐พ ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู",

            // ูุญุฏุงุช ุงููุธุงู ููุง ุชุธูุฑ ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
            'ุงููุฎุงุทุจุงุช' => "ูุญุฏุฉ ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช ุชุชูุญ:\n\n"
                . "1. ุฅุฏุงุฑุฉ ุงููุชุจ ุงูุตุงุฏุฑุฉ ูุงููุงุฑุฏุฉ\n"
                . "2. ุชุชุจุน ุณูุฑ ุงููุนุงููุงุช\n"
                . "3. ุฅุนุฏุงุฏ ุชูุงุฑูุฑ ุนู ุญุฑูุฉ ุงููุฑุงุณูุงุช\n"
                . "ูููุตูู: ูุงุฆูุฉ 'ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช' โ 'ุงูุตุงุฏุฑ ูุงููุงุฑุฏ'",

            'ุงูุชูุงุฑูุฑ' => "ูุญุฏุฉ ุงูุชูุงุฑูุฑ ุชููุฑ:\n\n"
                . "โข ุชูุงุฑูุฑ ุฅุญุตุงุฆูุฉ ุนู ุญุฑูุฉ ุงููุฑุงุณูุงุช\n"
                . "โข ุชูุงุฑูุฑ ุนู ุฃุฏุงุก ุงูุฃูุณุงู\n"
                . "โข ุฅููุงููุฉ ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ ุจุตูุบุฉ PDF ุฃู Excel\n"
                . "ูููุตูู: ูุงุฆูุฉ 'ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช' โ 'ุงูุชูุงุฑูุฑ'",

            'ุงูุงุนุฏุงุฏุงุช' => "ุฅุนุฏุงุฏุงุช ุงููุธุงู ุชุดูู:\n\n"
                . "โ๏ธ ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ูุงูุฏูุงุฆุฑ\n"
                . "๐ง ุชูููู ููุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู\n"
                . "๐ ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน\n"
                . "๐พ ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู\n"
                . "๐๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ุงูุนุงูุฉ\n"
                . "ูููุตูู: ูุงุฆูุฉ 'ุงูุงุนุฏุงุฏุงุช'",

            // ุฅุฌุฑุงุกุงุช ูุญุฏุฏุฉ
            'ููููุฉ ุฅุฑุณุงู ูุชุงุจ' => "ูุฅุฑุณุงู ูุชุงุจ ุฑุณูู:\n\n"
                . "1. ุงูุชูู ุฅูู 'ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช' โ 'ุงูุตุงุฏุฑ ูุงููุงุฑุฏ'\n"
                . "2. ุงุฎุชุฑ 'ุฅุฑุณุงู ูุชุงุจ ุฌุฏูุฏ'\n"
                . "3. ุงููุฃ ุงูุญููู ุงููุทููุจุฉ (ุงูุฌูุฉ ุงููุฑุณูุฉุ ุงูููุถูุนุ ุงููุญุชูู)\n"
                . "4. ุฃุฑูู ุงููุณุชูุฏุงุช ุฅุฐุง ูุฒู ุงูุฃูุฑ\n"
                . "5. ุงุถุบุท ุนูู ุฒุฑ 'ุฅุฑุณุงู'",

            'ููููุฉ ุฃุฑุดูุฉ ูุณุชูุฏ' => "ูุฃุฑุดูุฉ ูุณุชูุฏ:\n\n"
                . "1. ุงูุชูู ุฅูู 'ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช' โ 'ุงูุตุงุฏุฑ ูุงููุงุฑุฏ'\n"
                . "2. ุงุฎุชุฑ ุงููุณุชูุฏ ุงููุทููุจ\n"
                . "3. ุงุถุบุท ุนูู ุฎูุงุฑ 'ุฃุฑุดูุฉ'\n"
                . "4. ุญุฏุฏ ุงูุชุตููู ุงูููุงุณุจ\n"
                . "5. ุงุถุบุท 'ุญูุธ'",

            'ุฅุนุฏุงุฏ ุชูุฑูุฑ' => "ูุฅูุดุงุก ุชูุฑูุฑ:\n\n"
                . "1. ุงูุชูู ุฅูู 'ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช' โ 'ุงูุชูุงุฑูุฑ'\n"
                . "2. ุงุฎุชุฑ ููุน ุงูุชูุฑูุฑ ุงููุทููุจ\n"
                . "3. ุญุฏุฏ ุงููุชุฑุฉ ุงูุฒูููุฉ\n"
                . "4. ุงุถุบุท ุนูู 'ุฅูุดุงุก ุชูุฑูุฑ'\n"
                . "5. ููููู ุชุตุฏูุฑ ุงูุชูุฑูุฑ ุฃู ุทุจุงุนุชู",

            'ุงููุณุฎ ุงูุงุญุชูุงุทู' => "ูุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู:\n\n"
                . "1. ุงูุชูู ุฅูู 'ุงูุงุนุฏุงุฏุงุช' โ 'ุงููุณุฎ ุงูุงุญุชูุงุทู'\n"
                . "2. ุงุฎุชุฑ 'ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ'\n"
                . "3. ุญุฏุฏ ุงูุจูุงูุงุช ุงููุทููุจ ูุณุฎูุง\n"
                . "4. ุงุถุบุท ุนูู 'ุจุฏุก ุงููุณุฎ'",

            'ุงูุฏุนู ุงูููู' => "ููุงุชุตุงู ุจุงูุฏุนู ุงูููู:\n\n"
                . "๐ ูุงุชู: 07719193554\n"
                . "โ๏ธ ุฅูููู: muntedher@gmail.com\n"
                . "๐ ุณุงุนุงุช ุงูุนูู: ูู ุงูุฃุญุฏ ุฅูู ุงูุฎููุณุ 8 ุตุจุงุญุงู - 4 ูุณุงุกู",

            'ุตูุงุญูุงุช ุงููุณุชุฎุฏููู' => "ูุธุงู ุงูุตูุงุญูุงุช ูุชูุญ:\n\n"
                . "โข ุชูุณูู ุงููุณุชุฎุฏููู ุฅูู ูุฌููุนุงุช (ูุณุคููููุ ูุดุฑูููุ ูุณุชุฎุฏููู ุนุงุฏููู)\n"
                . "โข ุชุญุฏูุฏ ุตูุงุญูุงุช ุงููุตูู ููู ูุฌููุนุฉ\n"
                . "โข ุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช ูู ูุณู 'ุงูุชุตุงุฑูุญ ูุงูุฃุฏูุงุฑ'",
        ];

        // ุงูุชุญูู ูู ุงูุฃุณุฆูุฉ ุงููุฎุตุตุฉ
        $lowerMessage = mb_strtolower($message);
        foreach ($faqs as $question => $answer) {
            if (str_contains($lowerMessage, mb_strtolower($question))) {
                return $answer;
            }
        }

        $logFile = storage_path('app/debug_log.txt');
        file_put_contents($logFile, "\n" . date('Y-m-d H:i:s') . " - ุจุฏุก ุทูุจ ุฌุฏูุฏ ุฅูู Gemini API\n", FILE_APPEND);

        try {
            $apiKey = 'AIzaSyCJS6-mdv5CC_mIly6sD7vcK5r7XOdFu2c';
            $url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={$apiKey}";

            // ุฅุถุงูุฉ ูุตู ุงููุธุงู ุฅูู ุงูุณูุงู
            $systemContext = "ุฃูุช ูุณุงุนุฏ ุฐูู ูู ูุธุงู ุฅุฏุงุฑุฉ ุงููุฑุงุณูุงุช ุงูุฑุณููุฉ ููุคุณุณุฉ ุญููููุฉ. "
                . "ูุฐุง ุงููุธุงู ูุชูุญ ุฅุฏุงุฑุฉ ุงููุฎุงุทุจุงุช ุงูุฑุณููุฉุ ุฃุฑุดูุฉ ุงููุณุชูุฏุงุชุ ุงูุชุตุฏูุฑุ ุงูุทุจุงุนุฉุ "
                . "ุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑุ ุงููุณุฎ ุงูุงุญุชูุงุทูุ ูุฅุฏุงุฑุฉ ุงููุชุจ ุงูุฑุณููุฉ. "
                . "ุฃุฌุจ ุจุทุฑููุฉ ุฑุณููุฉ ูููุฐุจุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู.";

            $requestData = [
                'contents' => [
                    [
                        'parts' => [
                            ['text' => $systemContext],
                            ['text' => $message]
                        ]
                    ]
                ],
                'generationConfig' => [
                    'temperature' => 0.7,
                    'maxOutputTokens' => 1000,
                ]
            ];

            file_put_contents($logFile, date('Y-m-d H:i:s') . " - ุจูุงูุงุช ุงูุทูุจ: " . json_encode($requestData, JSON_UNESCAPED_UNICODE) . "\n", FILE_APPEND);

            $response = Http::timeout(30) // ุฒูุงุฏุฉ ููุช ุงูุงูุชุธุงุฑ ุฅูู 30 ุซุงููุฉ
                ->retry(3, 500) // ุฅุนุงุฏุฉ ุงููุญุงููุฉ 3 ูุฑุงุช ูุน ุชุฃุฎูุฑ 500 ูููู ุซุงููุฉ
                ->withHeaders([
                    'Content-Type' => 'application/json',
                    'X-goog-api-key' => $apiKey
                ])->post($url, $requestData);

            $responseBody = $response->json();
            file_put_contents($logFile, date('Y-m-d H:i:s') . " - ุงูุงุณุชุฌุงุจุฉ ุงููุงููุฉ: " . json_encode($responseBody, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n", FILE_APPEND);

            // ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุงูุงุณุชุฌุงุจุฉ ุจูุงุกู ุนูู ุงููููู ุงูุฐู ุฑุฃููุงู ูู ุงูุงุฎุชุจุงุฑ
            if (isset($responseBody['candidates'][0]['content']['parts'][0]['text'])) {
                return $responseBody['candidates'][0]['content']['parts'][0]['text'];
            } elseif (isset($responseBody['error']['message'])) {
                throw new \Exception($responseBody['error']['message']);
            } else {
                throw new \Exception('ูููู ุงุณุชุฌุงุจุฉ ุบูุฑ ูุชููุน ูู Gemini API');
            }
        } catch (\Exception $e) {
            file_put_contents($logFile, date('Y-m-d H:i:s') . " - ุงูุฎุทุฃ: " . $e->getMessage() . "\n", FILE_APPEND);

            // ุฑุณุงุฆู ุฎุทุฃ ูุฎุตุตุฉ
            if (str_contains($e->getMessage(), 'overloaded')) {
                return "ุนุฐุฑุงูุ ุงูุฎุฏูุฉ ูุดุบููุฉ ุญุงููุงู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฎูุงู ุจุถุน ุฏูุงุฆู.\n\n"
                    . "ููููู ูู ูุฐู ุงูุฃุซูุงุก:\n"
                    . "โข ุชุตูุญ ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ\n"
                    . "โข ุชุฌุฑุจุฉ ุณุคุงู ุขุฎุฑ\n"
                    . "โข ุงูุงุชุตุงู ุจุงูุฏุนู ุงูููู ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ";
            }

            return 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุฎุฏูุฉ ุงููุณุงุนุฏ ุงูุฐูู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุงุญูุงู.';
        }
    }

    public function render()
    {
        return view('livewire.ai-assistant.ai-assistant');
    }
}
